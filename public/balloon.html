<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Balloon Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  </head>

  <body>
    <h1>スマホを傾けて風船を飛ばそう🎈</h1>
    <div>
      <div>あなたのID: <span id="myid"></span></div>
      <button id="connect">ルームに入る</button>
    </div>

    <script>
      let socket = io.connect();

      // センサーデータ
      let beta = 0;  // 前後
      let gamma = 0; // 左右

      // クライアントID
      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerHTML = myid;

      // ルーム参加
      document.querySelector("#connect").addEventListener("click", function () {
        socket.emit("join", "game");
        this.remove();
      });

      // センサーデータ受信
      socket.on("sensor", function (data) {
        beta = parseFloat(data.b);
        gamma = parseFloat(data.g);
      });

      // --- p5.js描画 ---
      let x = 0;
      let y = 300;
      let vy = 0;
      let gravity = 0.2;   // 下に落ちる力
      let liftPower = 0.3;  // 前傾で上昇させる力

      function setup() {
        createCanvas(400, 600);
        noStroke();
        textAlign(CENTER);
      }

      function draw() {
        background(135, 206, 235); // 空色

        // 左右移動
        x += gamma * 0.2;

        // 上下制御
        // beta: 0 = 平ら、正の値 = 前傾、負の値 = 後傾
        // 前傾(beta>0)で上昇、後傾(beta<0)で下降
        let tilt = beta / 90;  // -1～1くらいに正規化
        vy -= tilt * liftPower; // 符号調整（前傾で上昇）

        vy += gravity; // 重力
        vy *= 0.95;    // 減速
        y += vy;

        // 画面端制限
        x = constrain(x, -width/2 + 30, width/2 - 30);
        y = constrain(y, -height/2 + 40, height/2 - 40);

        // 中心基準で描画
        push();
        translate(width/2, height/2);

        // 風船
        fill(255, 80, 80);
        ellipse(x, y, 60, 80);

        // 紐
        stroke(100);
        line(x, y + 40, x, y + 100);

        pop();

        // 説明
        noStroke();
        fill(0);
        textSize(15);
        text("スマホを前に傾けると上に、後ろに傾けると下に動くよ！", width/2, 30);
      }
    </script>
  </body>
</html>

